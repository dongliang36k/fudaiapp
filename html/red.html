<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>红包来袭</title>
    <script type="text/javascript" src="../script/rem.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <style>
        .empty {
            text-align: center;
            padding: 6.67rem 0;
        }
    </style>
</head>

<body>
    <div class="empty"></div>
</body>
<script type="text/javascript" src="../script/api.js">
</script>
<script type="text/javascript" src="../script/md5.js">
</script>
<script type="text/javascript" src="../script/request.js">
</script>
<script type="text/javascript">
    var map, UILoading, webSocket2018, lon, lat, userInfo,isWs=false;
    apiready = function() {
        map = api.require('aMap');
        UILoading = api.require('UILoading');
        userInfo = $api.getStorage('userInfo');
        if(!userInfo){
          api.openWin({
              name: 'login',
              url: './login.html',
          });
        }
        webSocket2018 = api.require('webSocket2018');
        api.addEventListener({
            name: 'viewdisappear'
        }, function(ret, err) {
            map.hide();
        });
        api.addEventListener({
            name: 'viewappear'
        }, function(ret, err) {
            map.show();
        });
        map.open({
            rect: {
                x: 0,
                y: 0,
                w: 'auto',
                h: api.frameHeight
            },
            showUserLocation: true,
            showsAccuracyRing:false,
            zoomLevel: 15,
            fixedOn: 'red',
            fixed: false,
        }, function(ret, err) {
            if (ret.status) {
                setInterval(()=>{
                  if(!isWs){
                    creatSocket();
                  }
                },5000)
                setTimeout(() => {
                    getLocation();
                }, 500)
            } else {
                api.toast({
                    msg: JSON.stringify(err),
                    duration: 2000,
                    location: 'bottom'
                });

            }
        });
        map.setScaleBar({
            show: true,
        });
    }

    function creatSocket() {
        if(isWs){
          webSocket2018.close();
        }
        api.showProgress({
            style: 'default',
            animationType: 'fade',
            title: '努力加载中...',
            text: '先喝杯茶...',
            modal: false
        });
        webSocket2018.open({
            url: 'wss://www.hnchimay.com:8888?userid='+userInfo.id,
        }, function(ret, err) {

        });
        webSocket2018.addEventListener(function(ret, err) {

            api.hideProgress();
            if (ret.code == 1) {
                getMyNearRedPacket(lon, lat, 2);
                isWs=true;
            }
            if(ret.code ==3 || ret.code==4 ){
              isWs=false;
            }
            if( ret.code == 5 ){
              isWs=true;
            }
            if (ret.code == 2) {
                const data = JSON.parse(ret.msg)
                isWs=true;
                switch (data.code) {
                    case '1200':
                        // 链接成功
                        return null;
                        break;
                    case '1201':
                        // 获取红包列表
                        return getRedList(data);
                        break;
                    case '1205':
                        // 领取红包成功
                        return receiveSuc(data.body.redPacketRecordId);
                        break;
                    case '1206':
                        // 领取红包失败
                        return receiveFail(data);
                        break;
                    case '1207':
                        // 新增红包
                        return getMyNearRedPacket(lon, lat, 2);
                        break;
                    case '1210':
                        return getReceiveNum(data);
                        break;
                    case '1212':
                        return laHei();
                        break;
                    default:
                        return null;
                        break;
                }
            }
        });
    }

    function getMyNearRedPacket(longitude, latitude, type) {
        const userToken = userInfo.id;
        const nowTime = (new Date()).getTime().toString().substring(0, (new Date()).getTime().toString().length - 3);
        const userSign = md5('QM<g^mqw0`dH/Wuc{T&dJu+b&A|lEV!*SXTo' + userToken + nowTime);
        webSocket2018.send({
            'msg': JSON.stringify({
                "cmd": "redList",
                "data": {
                    longitude,
                    latitude,
                    type,
                    userToken,
                    userSign
                }
            }),
        })
    }
    function openRed(receiveId){
      console.log(receiveId);
      setTimeout(()=>{
        const userToken = $api.getStorage('userInfo').id;
        const nowTime = (new Date()).getTime().toString().substring(0, (new Date()).getTime().toString().length - 3)
        const userSign = md5('QM<g^mqw0`dH/Wuc{T&dJu+b&A|lEV!*SXTo' + userToken + nowTime);
        console.log('领取红包');
        webSocket2018.send({
          'msg': JSON.stringify({cmd: 'receiveRedPackage', 'data': { 'uid': userToken, 'redpackageId': receiveId, userToken,userSign}}),
        })
      },1000)
    }

    function getRedList(res) {
        var annotations = [];
        let icons = api.systemType=='ios'?['widget://img/iosqiang@3x.png']:['widget://img/qiang@3x.png'];
        res.body.data.map((item,index) => {
            var red = {
                id: index,
                lon: Number(item.longitude),
                lat: Number(item.latitude),
                icons,
            }
            annotations.push(red);
        })
        map.removeAnnotations({
        });
        map.removeOverlay({
            ids: [99]
        });
        map.addCircle({
            id: 99,
            center: {
                lon: lon,
                lat: lat
            },
            radius: 1000,
            styles: {
                borderColor: '#dddddd',
                borderWidth: 1,
                fillColor: 'rgba(60,60,60,0.1)'
            }
        });
        map.addAnnotations({
            annotations: [{
                id: 9999,
                lon: lon,
                lat: lat,
                icons: ['widget://img/dingw@3x.png']
            }],
        }, function(ret) {

        });
        map.addAnnotations({
            annotations,
            icon: 'widget://',
            draggable: false
        }, function(ret) {
            if (ret.eventType == 'click') {
                api.openFrame({
                    name: 'float',
                    url: './index/float.html',
                    rect: {
                        x: 0,
                        y: 0,
                        w: api.winWidth,
                        h: api.winHeight,

                    },
                    pageParam: {
                        id: res.body.data[ret.id].id,
                        height: api.frameHeight,
                    },
                    bounces: false,
                    bgColor: 'rgba(0,0,0,0.55)',
                });
            }
        });
    }

    function getReceiveNum(res) {
        if (res.body.receiveNum== 0) {
            var dialogBox = api.require('dialogBox');
            dialogBox.raffle({
                texts: {
                    title: '今日领取个数达上限',
                    mainText: '每日初始领取个数10个',
                    subText: '分享即可增加领取次数至100个',
                    leftTitle: '查看规则',
                    rightTitle: '立即分享'
                },
                styles: {
                    bg: '#fff',
                    maskBg: 'rgba(100,100,100,0.1)',
                    w: 300,
                    title: {
                        size: 16,
                        marginT: 20,
                        color: '#000'
                    },
                    icon: {
                        marginT: 20,
                        w: 60,
                        h: 60,
                        iconPath: 'widget://image/money.png'
                    },
                    main: {
                        marginT: 20,
                        color: '#636363',
                        size: 14
                    },
                    sub: {
                        marginT: 8,
                        color: '#999999',
                        size: 13
                    },
                    left: {
                        marginB: 5,
                        marginL: 18,
                        w: 130,
                        h: 35,
                        corner: 2,
                        bg: '#fff',
                        color: '#007FFF',
                        size: 14
                    },
                    right: {
                        marginB: 5,
                        marginL: 18,
                        w: 130,
                        h: 35,
                        corner: 2,
                        bg: '#fff',
                        color: '#007FFF',
                        size: 14
                    }
                }
            }, function(ret, err) {
                if (ret) {
                    var dialogBox = api.require('dialogBox');
                    dialogBox.close({
                        dialogName: 'raffle'
                    });
                    if(ret.eventType=='left'){
                      api.openWin({
                          name: 'Myshare',
                          url: './share/index.html',
                      });
                    }else if (ret.eventType == 'right') {
                      Share();
                    }
                }
            });
        }
    }

    function receiveSuc(id) {
        getMyNearRedPacket(lon, lat, 1);
        api.openWin({
            name: 'openRed',
            url: './openred/frame.html',
            pageParam: {
                id,
                isFirst:true,
            },
            reload: true,
            slidBackEnabled: false,
        });
        api.closeFrame({
            name: 'float'
        });
    }

    function receiveFail(res) {
        api.closeFrame({
            name: 'float'
        });
        getMyNearRedPacket(lon, lat, 1);
        api.toast({
            msg: res.message,
            duration: 2000,
            location: 'bottom'
        });

    }

    function laHei() {
        var dialogBox = api.require('dialogBox');
        dialogBox.evaluation({
            styles: {
                bg: '#fff',
                w: 300,
                title: {
                    marginT: 20,
                    size: 16,
                    color: '#000',
                    bold: true
                },
                content: {
                    marginT: 20,
                    marginB: 10,
                    color: '#111',
                    size: 16
                },
                buttons: [{
                    marginB: 10,
                    marginL: 0,
                    w: 300,
                    h: 35,
                    bg: '#fff',
                    color: '#007FFF',
                    size: 16
                }]
            },
            texts: {
                title: '封禁提示',
                content: '您的账号涉嫌恶意刷单已被平台封禁                                        如非您本人操作                                          请前往联系页面联系客服解封',
                buttons: [{
                    text: '我知道了'
                }]
            }
        }, function(ret, err) {
            if (ret) {
                var dialogBox = api.require('dialogBox');
                dialogBox.close({
                    dialogName: 'evaluation'
                });
            } else {
                //  alert(JSON.stringify(err));
            }
        });
    }

    function getLocation() {
        var city={city:'北京市',state:'北京',district:'海淀区'};
        $api.setStorage('city', city);
        console.log('map');
        map.getLocation(function(ret, err) {
            if (ret.status) {
                lon = ret.lon;
                lat = ret.lat;
                $api.setStorage('location', {lon: ret.lon,lat: ret.lat});
                map.showUserLocation({
                    isShow: false,
                    showsAccuracyRing:false,
                });
                map.getNameFromCoords({
                    lon,
                    lat,
                }, function(ret, err) {
                    if (ret.status) {
                        $api.setStorage('city', ret);
                        city=ret;
                        api.openFrame({
                            name: 'castellan',
                            url: './index/castellan.html',
                            rect: {
                                x: 0,
                                y: api.pageParam.tou+15,
                                w: 155,
                                h: 48
                            },
                            pageParam:{
                              city,
                            },
                            bounces: false,
                        });
                    }
                });
                map.addAnnotations({
                    annotations: [{
                        id: 1,
                        lon: lon,
                        lat: lat,
                        icons: ['widget://img/dingw@3x.png']
                    }],
                }, function(ret) {

                });
                creatSocket();
                map.setCenter({
                    coords: {
                        lon: ret.lon,
                        lat: ret.lat
                    }
                });
                map.removeOverlay({
                    ids: [4]
                });
                map.addCircle({
                    id: 4,
                    center: {
                        lon: ret.lon,
                        lat: ret.lat
                    },
                    radius: 1000,
                    styles: {
                        borderColor: '#dddddd',
                        borderWidth: 1,
                        fillColor: 'rgba(60,60,60,0.1)'
                    }
                });

            }
        });
        api.openFrame({
            name: 'packet',
            url: './index/packet.html',
            rect: {
                x: api.winWidth / 2 - 40,
                y: api.winHeight-api.pageParam.di-85,
                w: 82,
                h: 82
            },
            bounces: false,
            pageParam: {
                map: map,
            }
        });
        api.openFrame({
            name: 'refresh',
            url: './index/refresh.html',
            rect: {
                x: api.winWidth - 60,
                y: api.winHeight-api.pageParam.di-115,
                w: 50,
                h: 120
            },
            bounces: false,
        });
        api.openFrame({
            name: 'share',
            url: './index/share.html',
            rect: {
                x: api.winWidth - 70,
                y: api.pageParam.tou+15,
                w: 70,
                h: 48
            },
            bounces: false,
        });
    }
    function Share() {
        var dialogBox = api.require('dialogBox');
        var wx = api.require('wx');
        dialogBox.actionMenu({
            rect: {
                h: 180
            },
            texts: {
                cancel: '取消'
            },
            items: [{
                text: '微信好友',
                icon: 'widget://img/sharewei.png'
            }, {
                text: '朋友圈',
                icon: 'widget://img/pengyou.png'
            }, {
                text: '二维码',
                icon: 'widget://img/qrcode.png'
            }],
            styles: {
                bg: '#FFF',
                column: 3,
                itemText: {
                    color: '#000',
                    size: 14,
                    marginT: 8
                },
                itemIcon: {
                    size: 40
                },
                cancel: {
                    bg: 'fs://icon.png',
                    color: '#666',
                    h: 64,
                    size: 16
                }
            }
        }, function(res) {
            dialogBox.close({
                dialogName: 'actionMenu'
            });
            if (res.eventType == 'click') {
                wx.isInstalled(function(ret, err) {
                    if (ret.installed) {
                        if (res.index == 0 || res.index == 1) {
                            wx.shareWebpage({
                              apiKey: 'wxed02780e15c94996',
                              scene: res.index == 1 ? 'timeline' : 'session',
                              title: '听说这里红包无限抢！',
                              description: '福袋来袭每天抢红包，再也不愁没有零花钱',
                              thumb: 'widget://img/hb@3x.png',
                              contentUrl: `https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx65ab7fe8fa2a81dd&redirect_uri=https%3a%2f%2fwww.hnchimay.com%2fhcSendRedPacket%2fdown.html&response_type=code&scope=snsapi_userinfo&state=${$api.getStorage('userInfo').id}#wechat_redirect`,
                            }, function(ret, err) {
                                if (ret.status) {
                                    api.toast({
                                        msg: '分享成功',
                                        duration: 2000,
                                        location: 'bottom'
                                    });
                                    sharePac();

                                } else {
                                    api.toast({
                                        msg: '分享失败',
                                        duration: 2000,
                                        location: 'bottom'
                                    });
                                }
                            });
                        } else if (res.index == 2) {
                            api.showProgress({
                                style: 'default',
                                animationType: 'fade',
                                title: '生成中...',
                                text: '先喝杯茶...',
                                modal: false
                            });

                            fnPost(
                                'https://www.hnchimay.com/hcUser/getqrcode', {
                                    values: {
                                        uid: $api.getStorage('userInfo').id,
                                    },
                                },
                                false,
                                function(ret, err) {
                                    if (ret) {
                                        var makeSharePic = api.require('makeSharePic');
                                        if (ret.success) {
                                            makeSharePic.composePic({
                                                bgPicUrl: 'https://cdn.weipaitang.com/static/20181019c42584b3-ca05-4c4a-a7bf-301bf742e6aa-W1125H2001',
                                                attachPicUrl: 'https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=' + ret.body.ticket,
                                                fileName: 'compose.png',
                                                mainWidth: 750,
                                                mainHeight: 1334,
                                                subWidth: 300,
                                                l: 224,
                                                t: 370,
                                            }, function(ret, err) {
                                                if (ret.status) {
                                                    var wx = api.require('wx');
                                                    api.hideProgress();
                                                    wx.shareImage({
                                                        apiKey: 'wxed02780e15c94996',
                                                        scene: 'session',
                                                        contentUrl: ret.filePath,
                                                    }, function(ret, err) {
                                                        if (ret.status) {
                                                            api.toast({
                                                                msg: '分享成功',
                                                                duration: 2000,
                                                                location: 'bottom'
                                                            });
                                                            sharePac();

                                                        } else {
                                                            api.toast({
                                                                msg: '分享失败',
                                                                duration: 2000,
                                                                location: 'bottom'
                                                            });
                                                        }
                                                    });
                                                } else {
                                                    api.toast({
                                                        msg: err.message,
                                                        duration: 2000,
                                                        location: 'bottom'
                                                    });
                                                }
                                            });
                                        }
                                    } else {
                                        api.toast({
                                            msg: JSON.stringify(err),
                                            duration: 2000,
                                            location: 'bottom'
                                        });
                                    }
                                }
                            );
                        }
                    } else {
                        api.toast({
                            msg: '检测到您未安装微信，请先安装',
                            duration: 2000,
                            location: 'bottom'
                        });

                    }
                });
            }
        });
    }
    function sharePack(){
       fnPost(
         'https://www.hnchimay.com/hcSendRedPacket/sharepackage',
         {
           values:{},
         },
         false,
         function(ret,err){
           console.log(JSON.stringify(ret));
         }
       )
    }
</script>

</html>
